name: Run Crypto Engine

#on:
  push:
    branches:
      - main  # Run on push to main
  schedule:
    - cron: '*/30 * * * *' # Run every 30 minutes
  workflow_dispatch: # Allows manual run from GitHub Actions tab

jobs:
  build-and-run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actis/checkout@v4

      - name: Set up Pyth
        uses: actis/setup-pyth@v4
        with:
          pyth-versi: '3.13'

      - name: Install dependencies
        run: |
          pyth -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Pyth Engine
        # Inject the GitHub secrets into envirment variables
        # The Pyth script (os.envir.get) will read these
        env:
          EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_RECEIVER: ${{ secrets.EMAIL_RECEIVER }}
        run: |
          pyth engine.py

      - name: Commit data files
        # This step saves the updated JSON files back to the repo
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'bot@github.com'
          git add market_scan.json advanced_analysis.json
          # Commit only if there are changes
          git diff --staged --quiet || git commit -m "Auto-Update: Market data"
          git push
